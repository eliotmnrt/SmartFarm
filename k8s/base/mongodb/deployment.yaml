apiVersion: apps/v1                      # API pour les Deployments
kind: Deployment                         # Type : Deployment
metadata:
  name: mongodb                          # Nom du Deployment
  namespace: fiware-platform             
  labels:
    app: mongodb                         # Label pour identifier ce Deployment
spec:
  replicas: 1                            # Nombre de Pods identiques, MongoDB ne supporte pas le scaling horizontal natif
  selector:
    matchLabels:
      app: mongodb                       # S√©lectionne les Pods avec ce label
  template:                              # Template du Pod √† cr√©er
    metadata:
      labels:
        app: mongodb                     # Labels du Pod
        version: v1                      # Version (pour Istio traffic splitting)
    spec:                                # Sp√©cification du Pod
      containers:                        # Liste des conteneurs
      - name: mongodb                    # Nom du conteneur
        image: mongo:4.4                 # Image Docker √† utiliser
        ports:
        - containerPort: 27017           # Port expos√© par le conteneur
          name: mongo                    # Nom du port (pour r√©f√©rence)
        volumeMounts:                    # Montage de volumes
        - name: mongo-storage            # Nom du volume (d√©fini plus bas)
          mountPath: /data/db            # Chemin dans le conteneur, MongoDB stocke ses donn√©es ici
        resources:                       # Ressources CPU/RAM
          requests:                      # Minimum garanti
            memory: "512Mi"              # 512 Mo de RAM
            cpu: "250m"                  # 0.25 CPU (1000m = 1 CPU)
          limits:                        # Maximum autoris√©
            memory: "1Gi"                # 1 Go de RAM max
            cpu: "500m"                  # 0.5 CPU max
        
        # üîç Probes : V√©rifications de sant√©
        livenessProbe:                   # "Est-ce que le conteneur est vivant ?"
          exec:
            command:
            - mongo                      # Ex√©cute la commande mongo
            - --eval                     
            - "db.adminCommand('ping')"  # Ping MongoDB
          initialDelaySeconds: 30        # Attendre 30s avant le 1er check
          periodSeconds: 10              # V√©rifier toutes les 10s
          timeoutSeconds: 5              # Timeout de 5s
          failureThreshold: 3            # Red√©marrer apr√®s 3 √©checs
        
        readinessProbe:                  # "Est-ce que le conteneur est pr√™t ?"
          exec:                          # (accepter du trafic)
            command:
            - mongo
            - --eval
            - "db.adminCommand('ping')"
          initialDelaySeconds: 10        # Premier check apr√®s 10s
          periodSeconds: 5               # V√©rifier toutes les 5s
          timeoutSeconds: 3              
      
      volumes:                           # D√©finition des volumes
      - name: mongo-storage              # Nom du volume
        persistentVolumeClaim:
          claimName: mongodb-pvc         # Utilise le PVC cr√©√© pr√©c√©demment